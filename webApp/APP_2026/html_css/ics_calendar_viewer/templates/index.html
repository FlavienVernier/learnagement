<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ICS Calendar Viewer</title>

  <!-- FullCalendar + Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
   :root {
        --bg: #f4f4f7;
        --fg: #222;
        --card: #fff;
        --accent: #007bff;
        --border: #ddd;
        --calendar-bg: #fff;
        --calendar-border: #ddd;
        --calendar-text: #222;
        --calendar-header-bg: #f8f9fa;
        --today-bg: rgba(13, 110, 253, 0.1);
    }

    [data-theme="dark"] {
        --bg: #1e1e1e;
        --fg: #eaeaea;
        --card: #2a2a2a;
        --accent: #4da3ff;
        --border: #444;
        --calendar-bg: #2a2a2a;
        --calendar-border: #444;
        --calendar-text: #eaeaea;
        --calendar-header-bg: #333;
        --today-bg: rgba(77, 163, 255, 0.2);
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    #calendar {
      max-width: 1200px;
      margin: 80px auto 40px auto;
      padding: 20px;
      background: var(--calendar-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    #calendar:hover {
      box-shadow: 0 10px 26px rgba(0,0,0,0.12);
    }

    /* FullCalendar Dark Mode Styles */
    [data-theme="dark"] .fc {
      background: var(--calendar-bg);
    }

    [data-theme="dark"] .fc-theme-standard td,
    [data-theme="dark"] .fc-theme-standard th {
      border-color: var(--calendar-border);
    }

    [data-theme="dark"] .fc-theme-standard .fc-scrollgrid {
      border-color: var(--calendar-border);
    }

    [data-theme="dark"] .fc-col-header-cell {
      background: var(--calendar-header-bg);
      color: var(--calendar-text);
    }

    [data-theme="dark"] .fc-daygrid-day,
    [data-theme="dark"] .fc-timegrid-slot {
      color: var(--calendar-text);
    }

    [data-theme="dark"] .fc-daygrid-day-number {
      color: var(--calendar-text);
    }

    [data-theme="dark"] .fc-day-today {
      background: var(--today-bg) !important;
    }

    [data-theme="dark"] .fc-button {
      background-color: var(--accent) !important;
      border-color: var(--accent) !important;
    }

    [data-theme="dark"] .fc-button:hover {
      background-color: #3a8dff !important;
      border-color: #3a8dff !important;
    }

    [data-theme="dark"] .fc-button-active {
      background-color: #2678e6 !important;
    }

    [data-theme="dark"] .fc-toolbar-title {
      color: var(--calendar-text);
    }

    /* Modal dark mode */
    [data-theme="dark"] .modal-content {
      background-color: var(--card);
      color: var(--fg);
    }

    [data-theme="dark"] .modal-header {
      border-bottom-color: var(--border);
    }

    [data-theme="dark"] .modal-footer {
      border-top-color: var(--border);
    }

    [data-theme="dark"] .form-control {
      background-color: #333;
      color: var(--fg);
      border-color: var(--border);
    }

    [data-theme="dark"] .form-control:focus {
      background-color: #3a3a3a;
      color: var(--fg);
      border-color: var(--accent);
    }

    [data-theme="dark"] .form-label {
      color: var(--fg);
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent);
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1000;
      font-weight: bold;
      border: none;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .top-bar {
      max-width: 1200px;
      margin: 20px auto 10px;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(90deg, #0d6efd, #6610f2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    [data-theme="dark"] .page-title {
      background: linear-gradient(90deg, #4da3ff, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Ensure event readability */
    .fc-event {
      color: white !important;
      font-weight: 500;
      border-radius: 6px !important;
      transition: transform 0.1s ease-in-out;
    }

    .fc-event:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .ics-event {
      background-color: #0d6efd !important;
      border-color: #0d6efd !important;
    }

    .local-event {
      background-color: #198754 !important;
      border-color: #198754 !important;
    }
  </style>
</head>

<body data-theme="light">

  <!-- TOP BAR -->
  <div class="top-bar">
    <h2 class="page-title">üìÖ My Calendar</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
      <i class="bi bi-plus-circle"></i> Add Event
    </button>
  </div>

  <!-- Dark Mode Toggle -->
  <button class="theme-toggle" id="themeToggle">
    <span id="themeIcon" style="font-size:1.2rem; user-select:none;">‚òÄÔ∏è</span>
  </button>

  <!-- CALENDAR -->
  <div id="calendar"></div>

  <!-- ADD EVENT MODAL -->
  <div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Event</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="addEventForm">

            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" name="title" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Start</label>
              <input type="datetime-local" name="start" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">End</label>
              <input type="datetime-local" name="end" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Location</label>
              <input type="text" name="location" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>

          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="saveEventBtn">
            <i class="bi bi-save"></i> Save Event
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        themeSystem: 'bootstrap5',
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        events: function(fetchInfo, success, failure) {
          fetch(`/events.json?start=${fetchInfo.start.toISOString()}&end=${fetchInfo.end.toISOString()}`)
            .then(r => r.json())
            .then(success)
            .catch(failure);
        },

        eventClassNames(info) {
          return info.event.extendedProps.source === 'local' ? 'local-event' : 'ics-event';
        },

        eventClick(info) {
          info.jsEvent.preventDefault();
          window.location.href = `/event/${encodeURIComponent(info.event.id)}`;
        }
      });

      calendar.render();

      // Dark Mode Toggle
      function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute("data-theme");
        const newTheme = current === "light" ? "dark" : "light";
        body.setAttribute("data-theme", newTheme);
        
        // Save preference
        localStorage.setItem('theme', newTheme);
      }

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);

      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      // Toggle Icon Updates
      function initThemeIcon() {
        const icon = document.getElementById('themeIcon');
        
        function updateIcon() {
          const isDark = document.body.getAttribute('data-theme') === 'dark';
          icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
          icon.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        }
        
        updateIcon();
        
        // Watch for theme changes
        new MutationObserver(mutations => {
          for (const m of mutations) {
            if (m.type === 'attributes' && m.attributeName === 'data-theme') {
              updateIcon();
              break;
            }
          }
        }).observe(document.body, { attributes: true });
      }
      
      initThemeIcon(); // Initialize the icon

      // SAVE EVENT BUTTON
      document.getElementById("saveEventBtn").addEventListener("click", function() {
        const form = document.getElementById("addEventForm");
        
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        
        const data = new FormData(form);

        fetch("/add_event", {
          method: "POST",
          body: data
        })
        .then(r => r.json())
        .then(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById("addEventModal"));
          modal.hide();
          form.reset();
          calendar.refetchEvents();
        })
        .catch(err => {
          console.error('Error saving event:', err);
          alert('Error saving event. Please try again.');
        });
      });
    });
  </script>
</body>
</html>